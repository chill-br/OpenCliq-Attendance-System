<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | OpenCliq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        .active-scale:active { transform: scale(0.95); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .avatar-hover:hover { border-color: #047857; transform: translateY(-1px); }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-stone-100 font-sans min-h-screen text-stone-700">
    
    <nav class="bg-white/90 backdrop-blur-md border-b border-stone-200 px-8 py-3 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center gap-2">
            <div class="bg-emerald-700 p-2 rounded-xl shadow-lg shadow-emerald-100">
                <i class="fas fa-bolt text-white"></i>
            </div>
            <h1 class="text-xl font-black text-stone-800 tracking-tight">Open<span class="text-emerald-700">Cliq</span></h1>
        </div>

        <div class="flex items-center gap-6">
            {% if user.is_staff %}
            <a href="{% url 'attendance:admin_dashboard' %}" class="hidden md:flex items-center gap-2 text-stone-500 hover:text-emerald-700 transition group">
                <div class="bg-stone-100 group-hover:bg-emerald-50 p-2 rounded-lg transition">
                    <i class="fas fa-users-viewfinder text-xs"></i>
                </div>
                <span class="text-[10px] font-black uppercase tracking-wider">Admin Dashboard</span>
            </a>
            <div class="h-6 w-[1px] bg-stone-200 hidden md:block"></div>
            {% endif %}

            <a href="{% url 'attendance:profile-edit' %}" class="flex items-center gap-3 group">
                <div class="text-right hidden sm:block">
                    <p class="text-[10px] text-orange-500 uppercase font-black leading-none">{{ user.department|default:"Standard" }}</p>
                    <p class="text-sm font-bold text-stone-800 group-hover:text-emerald-700 transition">{{ user.username }}</p>
                </div>
                <div class="w-10 h-10 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-700 font-bold border-2 border-white shadow-sm avatar-hover transition-all overflow-hidden">
                    {% if user.avatar %}
                        <img src="{{ user.avatar.url }}" class="w-full h-full object-cover">
                    {% else %}
                        {{ user.username|slice:":1"|upper }}
                    {% endif %}
                </div>
            </a>

            <form action="{% url 'logout' %}" method="post" class="border-l pl-4 border-stone-200">
                {% csrf_token %}
                <button type="submit" class="text-stone-400 hover:text-rose-500 p-2 transition-colors">
                    <i class="fas fa-power-off text-lg"></i>
                </button>
            </form>
        </div>
    </nav>

    <div class="bg-white border-b border-stone-200 shadow-sm px-8 py-3">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-6">
            <div class="flex items-center gap-8">
                <div class="flex flex-col">
                    <span class="text-[10px] font-black text-stone-400 uppercase tracking-widest">Shift Status</span>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-2 w-2">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full {% if is_online %}bg-emerald-400{% else %}bg-stone-300{% endif %} opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-2 w-2 {% if is_online %}bg-emerald-500{% else %}bg-stone-400{% endif %}"></span>
                        </span>
                        <span class="text-sm font-bold {% if is_online %}text-emerald-700{% else %}text-stone-500{% endif %}">
                            {% if is_online %}
                                {% if active_session.on_break %}On Break ({{ active_session.break_type }}){% else %}Active Session{% endif %}
                            {% else %}Not Checked In{% endif %}
                        </span>
                    </div>
                </div>
                {% if is_online %}
                <div class="h-8 w-[1px] bg-stone-200 hidden md:block"></div>
                <div>
                    <span class="text-[10px] font-black text-stone-400 uppercase tracking-widest">Live Duration</span>
                    <p id="live-timer" class="text-sm font-black text-emerald-700">00:00:00</p>
                </div>
                {% endif %}
            </div>

            <div class="flex items-center gap-4">
                {% if is_online %}
                    <form method="POST" action="{% url 'attendance:toggle-break' %}" class="flex items-center gap-2">
                        {% csrf_token %}
                        {% if not active_session.on_break %}
                            <select name="break_type" class="bg-stone-100 text-[10px] font-bold p-2 rounded-xl outline-none">
                                <option value="LUNCH">üç¥ Lunch</option>
                                <option value="SHORT">‚òï Break</option>
                            </select>
                            <button type="submit" class="bg-orange-500 hover:bg-orange-600 text-white text-[10px] font-black px-4 py-2 rounded-xl shadow-md transition-all active-scale">START BREAK</button>
                        {% else %}
                            <button type="submit" class="bg-emerald-600 hover:bg-emerald-700 text-white text-[10px] font-black px-4 py-2 rounded-xl shadow-md transition-all active-scale">END BREAK</button>
                        {% endif %}
                    </form>
                {% endif %}

                <form id="attendance-form" action="{% url 'attendance:toggle-attendance' %}" method="POST" class="flex items-center gap-3">
                    {% csrf_token %}
                    <input type="hidden" name="latitude" id="id_lat" value="0" />
                    <input type="hidden" name="longitude" id="id_lng" value="0" />
                    {% if not is_online %}
                        <div class="bg-stone-100 rounded-xl p-1 flex items-center border border-stone-200">
                            <select name="work_mode" id="work_mode_select" class="bg-transparent text-xs font-bold text-stone-600 px-3 py-1.5 outline-none">
                                <option value="OFFICE">üè¢ Office</option>
                                <option value="REMOTE">üè† Remote</option>
                            </select>
                        </div>
                        <button type="button" id="check-in-btn" onclick="handleAttendance()" class="bg-emerald-700 hover:bg-emerald-800 text-white text-xs font-black px-6 py-2.5 rounded-xl shadow-md transition-all active-scale">CHECK IN</button>
                    {% else %}
                        <button type="submit" id="check-out-btn" class="bg-rose-500 hover:bg-rose-600 text-white text-xs font-black px-6 py-2.5 rounded-xl shadow-md transition-all active-scale">CHECK OUT</button>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 p-8">
        
        <aside class="lg:col-span-4 space-y-6">
            <div class="bg-white rounded-3xl shadow-sm border border-stone-200 p-6 flex flex-col h-[550px]">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-black text-stone-800 text-sm tracking-tight uppercase italic">Team Blog</h3>
                    <i class="fas fa-rss text-orange-400 text-xs"></i>
                </div>
                
                <form method="POST" enctype="multipart/form-data" class="mb-4 space-y-2">
                    {% csrf_token %}
                    <textarea name="post_content" required rows="2" class="w-full bg-stone-50 border border-stone-100 rounded-2xl p-3 text-xs outline-none focus:ring-2 focus:ring-emerald-500/20" placeholder="What's happening?"></textarea>
                    <div class="flex justify-between items-center">
                        <label class="cursor-pointer text-stone-400 hover:text-emerald-700 transition">
                            <i class="fas fa-camera"></i>
                            <input type="file" name="post_image" class="hidden" accept="image/*">
                        </label>
                        <button type="submit" class="bg-emerald-700 text-white px-5 py-1.5 rounded-xl text-xs font-bold shadow-sm hover:bg-emerald-800 transition-all">Share</button>
                    </div>
                </form>

                <div class="flex-1 overflow-y-auto space-y-4 custom-scrollbar pr-2">
                    {% for post in posts %}
                    <div class="p-4 rounded-2xl bg-stone-50 transition hover:bg-stone-100/50">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-7 h-7 bg-white rounded-full flex items-center justify-center text-[9px] font-black border border-stone-100 text-emerald-700 shadow-sm overflow-hidden">
                                    {% if post.author.avatar %}
                                        <img src="{{ post.author.avatar.url }}" class="w-full h-full object-cover">
                                    {% else %}
                                        {{ post.author.username|slice:":2"|upper }}
                                    {% endif %}
                                </div>
                                <div>
                                    <p class="text-[10px] font-black text-stone-800">{{ post.author.username }}</p>
                                    <p class="text-[8px] text-stone-400">{{ post.created_at|timesince }} ago</p>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-stone-600 mb-2 leading-relaxed">{{ post.content }}</p>
                        {% if post.image %}
                            <img src="{{ post.image.url }}" class="rounded-xl w-full h-32 object-cover border border-stone-200 shadow-sm">
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-stone-200 p-6">
                <h3 class="font-black text-stone-800 text-sm tracking-tight uppercase mb-4 flex items-center justify-between">
                    Online Now
                    <span class="bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full">{{ online_team|length }}</span>
                </h3>
                <div class="space-y-4">
                    {% for member in online_team %}
                    <div class="flex items-center justify-between group">
                        <div class="flex items-center gap-3">
                            <div class="w-9 h-9 rounded-full bg-emerald-50 border border-emerald-100 flex items-center justify-center text-emerald-700 text-xs font-black overflow-hidden">
                                {% if member.avatar %}
                                    <img src="{{ member.avatar.url }}" class="w-full h-full object-cover">
                                {% else %}
                                    {{ member.username|slice:":1"|upper }}
                                {% endif %}
                            </div>
                            <p class="text-xs font-bold text-stone-700">{{ member.username }}</p>
                        </div>
                        <span class="w-2 h-2 bg-emerald-500 rounded-full"></span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </aside>

        <div class="lg:col-span-8 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-5 rounded-3xl border border-stone-200 shadow-sm">
                    <span class="text-[10px] font-black text-stone-400 uppercase block mb-1">Total Today</span>
                    <h4 class="text-2xl font-black text-stone-800">{{ today_hours }}<span class="text-xs text-stone-300 ml-1">h</span></h4>
                </div>
                <div class="bg-white p-5 rounded-3xl border border-stone-200 shadow-sm">
                    <span class="text-[10px] font-black text-stone-400 uppercase block mb-1">This Month</span>
                    <h4 class="text-2xl font-black text-stone-800">{{ monthly_hours }}<span class="text-xs text-stone-300 ml-1">h</span></h4>
                </div>
                <div class="bg-white p-5 rounded-3xl border border-stone-200 shadow-sm">
                    <span class="text-[10px] font-black text-stone-400 uppercase block mb-1">Avg Check-In</span>
                    <h4 class="text-2xl font-black text-stone-800">{{ avg_check_in }}</h4>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
                <div class="bg-white rounded-3xl shadow-sm border border-stone-200 p-6 h-[350px] flex flex-col">
                    <h3 class="font-black text-stone-800 text-sm tracking-tight uppercase mb-4">My Focus</h3>
                    <div id="todo-list" class="flex-1 overflow-y-auto space-y-2 mb-4 custom-scrollbar">
                        {% for task in tasks %}
                        <div class="flex items-center justify-between group p-3 bg-stone-50 rounded-2xl" id="task-container-{{ task.id }}">
                            <div class="flex items-center gap-3">
                                <input type="checkbox" onclick="toggleTask({{ task.id }})" {% if task.is_completed %}checked{% endif %} class="w-4 h-4 rounded border-stone-300 text-emerald-700" />
                                <span class="text-xs font-bold text-stone-600 {% if task.is_completed %}line-through opacity-40{% endif %}">{{ task.text }}</span>
                            </div>
                            <button onclick="deleteTask({{ task.id }})" class="text-stone-300 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash text-[10px]"></i></button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="task-input" placeholder="New task..." class="flex-1 bg-stone-100 border-none rounded-xl px-4 py-2 text-xs outline-none focus:ring-2 focus:ring-emerald-500/20" />
                        <button onclick="addTask()" class="bg-stone-800 text-white px-4 rounded-xl hover:bg-emerald-700 transition-colors"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div class="bg-white rounded-3xl shadow-sm border border-stone-200 p-6 h-[350px] overflow-y-auto custom-scrollbar">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-black text-stone-800 text-sm tracking-tight uppercase italic text-orange-500">Scheduled</h3>
                        {% if user.is_staff %}
                        <a href="{% url 'attendance:create-meeting' %}" class="bg-stone-800 hover:bg-emerald-700 text-white text-[9px] font-black px-3 py-1.5 rounded-lg transition shadow-sm flex items-center gap-2">
                            <i class="fas fa-plus"></i> SCHEDULE
                        </a>
                        {% endif %}
                    </div>
                    <div class="space-y-3">
                        {% for meeting in meetings %}
                        <div class="p-4 rounded-2xl bg-stone-50 border border-stone-100 hover:border-emerald-200 transition-all">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[10px] font-black text-emerald-700">{{ meeting.start_time|time:"H:i" }}</span>
                                {% if meeting.meeting_link %}
                                <a href="{{ meeting.meeting_link }}" target="_blank" class="text-[9px] font-black text-white bg-emerald-600 px-2 py-0.5 rounded-md">JOIN CALL</a>
                                {% endif %}
                            </div>
                            <h4 class="text-xs font-black text-stone-800">{{ meeting.title }}</h4>
                        </div>
                        {% empty %}
                        <p class="text-[10px] text-stone-400 text-center py-12 italic">No meetings scheduled</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-stone-200 shadow-sm overflow-hidden">
                <div class="p-5 border-b border-stone-50 flex justify-between items-center bg-stone-50/30">
                    <h3 class="font-black text-stone-800 text-sm tracking-tight uppercase">History</h3>
                    <a href="{% url 'attendance:export-attendance' %}" class="text-[10px] font-black text-emerald-700 bg-emerald-50 px-3 py-1 rounded-full hover:bg-emerald-100 transition tracking-widest uppercase">Export CSV</a>
                </div>
                <div class="max-h-[300px] overflow-y-auto custom-scrollbar">
                    <table class="w-full text-left">
                        <thead class="sticky top-0 bg-stone-50 text-[9px] font-black text-stone-400 uppercase tracking-widest">
                            <tr><th class="px-8 py-3">Date</th><th class="px-8 py-3">In</th><th class="px-8 py-3 text-right">Total</th></tr>
                        </thead>
                        <tbody class="divide-y divide-stone-50">
                            {% for log in logs %}
                            <tr class="text-xs hover:bg-stone-50/50 transition">
                                <td class="px-8 py-4 font-bold text-stone-600">{{ log.date|date:"D, d M" }}</td>
                                <td class="px-8 py-4 text-stone-400 font-medium">{{ log.check_in|time:"H:i" }}</td>
                                <td class="px-8 py-4 text-right font-black text-emerald-700">
                                    {% if log.check_out %}{{ log.get_duration }}{% else %}<span class="text-orange-500 animate-pulse">In Progress</span>{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-stone-200 shadow-sm p-8">
                <canvas id="activityChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Attendance Logic
        function handleAttendance() {
            const btn = document.getElementById('check-in-btn');
            const form = document.getElementById('attendance-form');
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            if (document.getElementById('work_mode_select').value === 'REMOTE') { form.submit(); return; }
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((p) => {
                    document.getElementById('id_lat').value = p.coords.latitude;
                    document.getElementById('id_lng').value = p.coords.longitude;
                    form.submit();
                }, () => { alert("Location required for Office mode."); btn.disabled = false; btn.innerText = "CHECK IN"; });
            }
        }

        // Task Management Logic - Fetch URLs must include /attendance/ to match urls.py
        function addTask() {
            const val = document.getElementById('task-input').value;
            if (!val) return;
            fetch("{% url 'attendance:add-task' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrftoken },
                body: JSON.stringify({ text: val })
            }).then(() => location.reload());
        }

        function deleteTask(id) {
            fetch(`/attendance/task/delete/${id}/`, { 
                method: "POST", 
                headers: { "X-CSRFToken": csrftoken } 
            }).then(() => {
                const el = document.getElementById(`task-container-${id}`);
                if(el) el.remove();
            });
        }

        function toggleTask(id) {
            fetch(`/attendance/task/toggle/${id}/`, { 
                method: "POST", 
                headers: { "X-CSRFToken": csrftoken } 
            });
        }

        // Timer Logic
        {% if is_online and active_session %}
        let startTime = new Date("{{ active_session.check_in|date:'c' }}").getTime();
        function updateTimer() {
            const diff = new Date().getTime() - startTime;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('live-timer').innerText = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
        setInterval(updateTimer, 1000); updateTimer();
        {% endif %}

        // Chart.js
        const ctx = document.getElementById('activityChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_days|safe }},
                datasets: [{
                    data: {{ chart_data|safe }},
                    borderColor: '#047857',
                    tension: 0.4,
                    fill: true,
                    backgroundColor: 'rgba(4, 120, 87, 0.05)',
                    pointRadius: 4,
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    </script>
</body>
</html>